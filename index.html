<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ElXora - AI Lua Scripter for Roblox</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Orbitron:wght@500;700&display=swap" rel="stylesheet"/>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-okaidia.min.css" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <style>
    :root {
      --bg: #ffffff;
      --sidebar-bg: #f8f9ff;
      --card-bg: #ffffff;
      --purple: #6b46c1;
      --purple-light: #9f7aea;
      --purple-dark: #553c9a;
      --text: #1a202c;
      --text-muted: #718096;
      --border: #e2e8f0;
    }
    * { margin:0; padding:0; box-sizing:border-box; }
    body {
      background:var(--bg);
      color:var(--text);
      font-family:'Inter',sans-serif;
      height:100vh;
      display:flex;
      overflow:hidden;
      font-size:clamp(0.95rem, 2.8vw, 1.05rem);
    }
    .access-screen {
      position:fixed;
      inset:0;
      background:rgba(255,255,255,0.98);
      display:flex;
      align-items:center;
      justify-content:center;
      z-index:1000;
      transition:opacity 0.5s;
    }
    .access-screen.hidden {
      opacity:0;
      pointer-events:none;
      display:none !important;
    }
    .access-card {
      background:var(--card-bg);
      border:2px solid var(--purple-light);
      border-radius:1.5rem;
      padding:clamp(2rem, 6vw, 4rem) clamp(1.5rem, 5vw, 3rem);
      max-width:clamp(340px, 85vw, 480px);
      width:90%;
      text-align:center;
      box-shadow:0 10px 40px rgba(107,70,193,0.15);
    }
    .access-card h1.glow {
      font-family:'Orbitron',sans-serif;
      font-size:clamp(2.8rem, 10vw, 4.5rem);
      color:var(--purple);
      margin-bottom:1.5rem;
      text-shadow:0 0 1.5rem rgba(107,70,193,0.4);
    }
    .g_id_signin {
      margin:1.5rem auto;
    }
    .error { color:#e53e3e; margin-top:1rem; font-size:1rem; }
    .sidebar {
      width:clamp(220px, 28vw, 260px);
      background:var(--sidebar-bg);
      border-right:1px solid var(--border);
      padding:clamp(1rem, 3vw, 1.5rem);
      overflow-y:auto;
      flex-shrink:0;
      display:flex;
      flex-direction:column;
      justify-content:space-between;
    }
    .sidebar-header {
      font-family:'Orbitron',sans-serif;
      color:var(--purple);
      font-size:clamp(1.6rem, 5vw, 2rem);
      margin-bottom:1.5rem;
      text-align:center;
      cursor:pointer;
      transition:color 0.2s;
    }
    .sidebar-header:hover { color:var(--purple-dark); }
    .user-profile {
      display:flex;
      align-items:center;
      gap:0.8rem;
      padding:0.8rem;
      border-radius:1rem;
      background:rgba(107,70,193,0.08);
      margin:0 0 1rem 0;
      position:sticky;
      bottom:1rem;
      left:0;
      right:0;
      z-index:5;
      cursor:pointer;
    }
    .user-avatar {
      width:clamp(40px, 6vw, 52px);
      height:clamp(40px, 6vw, 52px);
      border-radius:50%;
      object-fit:cover;
      border:2px solid var(--purple-light);
    }
    .user-name {
      font-weight:600;
      font-size:clamp(1rem, 3vw, 1.15rem);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      color:var(--purple-dark);
    }
    .new-chat {
      background:var(--purple);
      color:white;
      padding:0.9rem;
      border-radius:0.9rem;
      text-align:center;
      cursor:pointer;
      font-weight:600;
      margin-bottom:1.2rem;
      transition:background 0.2s;
    }
    .new-chat.disabled {
      background:#ccc;
      cursor:not-allowed;
    }
    .new-chat:hover:not(.disabled) { background:var(--purple-dark); }
    .chat-list {
      display:flex;
      flex-direction:column;
      gap:0.6rem;
      flex:1;
      overflow-y:auto;
    }
    .chat-item {
      padding:0.6rem 0.8rem;
      background:#f1f5f9;
      border-radius:0.7rem;
      cursor:pointer;
      transition:background 0.2s;
      font-size:0.95rem;
      display:flex;
      align-items:center;
      justify-content:space-between;
    }
    .chat-item:hover { background:#e2e8f0; }
    .chat-item.active { background:var(--purple-light); color:white; }
    .chat-actions {
      display:flex;
      gap:0.4rem;
    }
    .chat-action {
      cursor:pointer;
      font-size:0.9rem;
      opacity:0.7;
    }
    .chat-action:hover { opacity:1; }
    .main {
      flex:1;
      display:flex;
      flex-direction:column;
    }
    .chat-header {
      padding:1rem 1.5rem;
      background:white;
      border-bottom:1px solid var(--border);
      font-size:clamp(1.2rem, 4vw, 1.4rem);
      color:var(--purple);
      font-weight:600;
    }
    .chat-messages {
      flex:1;
      padding:1.5rem;
      overflow-y:auto;
      display:flex;
      flex-direction:column;
      gap:1.25rem;
    }
    .message {
      max-width:86%;
      padding:0.9rem 1.3rem;
      border-radius:1.2rem;
      display:flex;
      align-items:flex-start;
      gap:0.8rem;
      font-size:clamp(0.95rem, 3vw, 1.05rem);
    }
    .ai-message {
      align-self:flex-start;
      background:#f3e8ff;
      border-radius:1.2rem 1.2rem 1.2rem 0.3rem;
      color:#2d3748;
    }
    .user-message {
      align-self:flex-end;
      background:var(--purple);
      border-radius:1.2rem 1.2rem 0.3rem 1.2rem;
      color:white;
      flex-direction:row-reverse;
    }
    .avatar {
      width:clamp(32px, 5vw, 40px);
      height:clamp(32px, 5vw, 40px);
      border-radius:50%;
      background:var(--purple-light);
      display:flex;
      align-items:center;
      justify-content:center;
      font-weight:bold;
      font-size:1rem;
      flex-shrink:0;
    }
    .message-content {
      white-space:pre-wrap;
      flex:1;
    }
    .input-bar {
      padding:1rem 1.5rem;
      background:white;
      border-top:1px solid var(--border);
      display:flex;
      align-items:center;
      gap:0.8rem;
      position:fixed;
      bottom:0;
      left:0;
      right:0;
      z-index:10;
    }
    textarea {
      flex:1;
      min-height:52px;
      max-height:160px;
      padding:0.9rem 1.2rem;
      background:#f7fafc;
      border:1px solid var(--border);
      border-radius:1rem;
      color:var(--text);
      font-size:1rem;
      resize:none;
      outline:none;
    }
    textarea:focus {
      border-color:var(--purple);
      box-shadow:0 0 0 3px rgba(107,70,193,0.2);
    }
    .input-icon {
      width:44px;
      height:44px;
      background:#f1f5f9;
      border-radius:50%;
      display:flex;
      align-items:center;
      justify-content:center;
      cursor:pointer;
      font-size:1.3rem;
      transition:background 0.2s;
    }
    .input-icon:hover { background:#e2e8f0; }
    .send-btn, .stop-btn {
      width:50px;
      height:50px;
      background:var(--purple);
      border:none;
      border-radius:50%;
      color:white;
      font-weight:bold;
      font-size:1.5rem;
      cursor:pointer;
      display:flex;
      align-items:center;
      justify-content:center;
      transition:background 0.2s;
    }
    .send-btn:hover, .stop-btn:hover { background:var(--purple-dark); }
    .blinking-cursor {
      color:var(--purple);
      animation:blink 0.8s infinite;
    }
    @keyframes blink { 50% { opacity:0; } }
    .image-preview {
      max-width:200px;
      border-radius:0.8rem;
      margin-top:0.5rem;
    }
    .logout-overlay {
      position:fixed;
      inset:0;
      background:rgba(0,0,0,0.5);
      display:none;
      align-items:center;
      justify-content:center;
      z-index:1001;
    }
    .logout-card {
      background:white;
      border-radius:1rem;
      padding:2rem;
      text-align:center;
      box-shadow:0 10px 30px rgba(0,0,0,0.2);
      max-width:300px;
      width:90%;
    }
    .logout-btn {
      background:#e53e3e;
      color:white;
      padding:0.8rem 1.5rem;
      border:none;
      border-radius:0.8rem;
      cursor:pointer;
      margin-top:1rem;
      width:100%;
    }
  </style>
</head>
<body>

  <!-- Login Overlay -->
  <div class="access-screen" id="accessScreen">
    <div class="access-card">
      <h1 class="glow">ElXora</h1>
      <p>Login with Google to continue</p>

      <div id="g_id_onload"
           data-client_id="101876231674-jg0de3j1ftj1s708dt236shjn6ph8ar3.apps.googleusercontent.com"
           data-callback="handleGoogleLogin"
           data-auto_prompt="false">
      </div>
      <div class="g_id_signin" data-type="standard" data-size="large" data-theme="outline" data-text="signin_with" data-shape="pill" data-logo_alignment="left"></div>

      <p id="errorMsg" class="error"></p>
    </div>
  </div>

  <!-- Logout Overlay -->
  <div class="logout-overlay" id="logoutOverlay">
    <div class="logout-card">
      <h2>Log out?</h2>
      <p>You will be signed out of ElXora.</p>
      <button class="logout-btn" id="confirmLogout">Log out</button>
      <button style="margin-top:0.8rem;" onclick="document.getElementById('logoutOverlay').style.display='none'">Cancel</button>
    </div>
  </div>

  <!-- Sidebar -->
  <div class="sidebar" id="sidebar">
    <div class="sidebar-header" onclick="location.reload()">ElXora</div>

    <div class="user-profile" id="userProfile" style="display:none;">
      <img id="userAvatar" class="user-avatar" src="" alt="Profile" />
      <div class="user-name" id="userName"></div>
    </div>

    <div class="new-chat" id="newChatBtn">+ New Chat</div>
    <div class="chat-list" id="chatList"></div>
  </div>

  <!-- Main Chat -->
  <div class="main" id="mainContent">
    <div class="chat-header">Chat with ElXora</div>
    <div class="chat-messages" id="chatContainer"></div>

    <div class="input-bar">
      <div class="input-icon" id="fileBtn" title="Attach file/image">üìé</div>
      <textarea id="prompt" placeholder="Ask me anything Roblox..." rows="1"></textarea>
      <button id="generateBtn" class="send-btn">‚Üë</button>
      <button id="stopBtn" class="stop-btn" style="display:none;">Stop</button>
    </div>
  </div>

  <!-- Hidden file input -->
  <input type="file" id="fileInput" accept="image/*" style="display:none;">

  <script>
    let currentUserEmail = null;
    let chats = [];
    let currentChatId = null;
    let currentTypingTimeout = null;
    let isGenerating = false;

    const chatContainer = document.getElementById('chatContainer');
    const chatListEl = document.getElementById('chatList');
    const newChatBtn = document.getElementById('newChatBtn');
    const generateBtn = document.getElementById('generateBtn');
    const stopBtn = document.getElementById('stopBtn');
    const userProfile = document.getElementById('userProfile');
    const logoutOverlay = document.getElementById('logoutOverlay');

    // Google Login Handler
    function handleGoogleLogin(response) {
      const jwt = response.credential;
      const payload = JSON.parse(atob(jwt.split('.')[1]));

      localStorage.setItem("google_user", JSON.stringify(payload));

      document.getElementById('accessScreen').classList.add('hidden');
      document.getElementById('accessScreen').style.display = 'none';

      alert("Login successful! Please refresh the page to enter ElXora.");
    }

    // Load user & chats after refresh
    const savedUser = localStorage.getItem("google_user");
    if (savedUser) {
      const payload = JSON.parse(savedUser);
      currentUserEmail = payload.email;

      document.getElementById('accessScreen').classList.add('hidden');
      document.getElementById('accessScreen').style.display = 'none';
      document.getElementById('mainContent').style.display = 'flex';
      document.getElementById('sidebar').style.display = 'block';
      document.getElementById('userProfile').style.display = 'flex';
      document.getElementById('userAvatar').src = payload.picture || 'https://via.placeholder.com/52';
      document.getElementById('userName').textContent = payload.name || 'User';

      const userChatsKey = `elxora_chats_${currentUserEmail}`;
      chats = JSON.parse(localStorage.getItem(userChatsKey)) || [{ id: Date.now(), title: 'New Chat', messages: [] }];
      currentChatId = chats[0].id;
      renderChatList();
      loadChat(currentChatId);
    }

    // Profile click ‚Üí show logout UI
    userProfile.addEventListener('click', () => {
      logoutOverlay.style.display = 'flex';
    });

    // Confirm logout
    document.getElementById('confirmLogout').addEventListener('click', () => {
      localStorage.removeItem("google_user");
      logoutOverlay.style.display = 'none';
      document.getElementById('accessScreen').style.display = 'flex';
      document.getElementById('mainContent').style.display = 'none';
      document.getElementById('sidebar').style.display = 'none';
      document.getElementById('userProfile').style.display = 'none';
    });

    function renderChatList() {
      chatListEl.innerHTML = '';
      chats.forEach(chat => {
        const item = document.createElement('div');
        item.className = 'chat-item' + (chat.id === currentChatId ? ' active' : '');
        item.innerHTML = `
          <span>${chat.title || 'New Chat'}</span>
          <div class="chat-actions">
            <span class="chat-action" onclick="event.stopPropagation(); renameChat('${chat.id}')">‚úèÔ∏è</span>
            <span class="chat-action" onclick="event.stopPropagation(); deleteChat('${chat.id}')">üóëÔ∏è</span>
          </div>
        `;
        item.onclick = () => loadChat(chat.id);
        chatListEl.appendChild(item);
      });

      // Disable new chat if max reached
      if (chats.length >= 20) {
        newChatBtn.classList.add('disabled');
        newChatBtn.textContent = 'Max chats (20)';
        newChatBtn.onclick = null;
      } else {
        newChatBtn.classList.remove('disabled');
        newChatBtn.textContent = '+ New Chat';
        newChatBtn.onclick = createNewChat;
      }
    }

    function createNewChat() {
      if (chats.length >= 20) return;
      const newId = Date.now();
      chats.push({ id: newId, title: 'New Chat', messages: [] });
      currentChatId = newId;
      saveChats();
      renderChatList();
      chatContainer.innerHTML = '';
    }

    function saveChats() {
      if (!currentUserEmail) return;
      const userChatsKey = `elxora_chats_${currentUserEmail}`;
      localStorage.setItem(userChatsKey, JSON.stringify(chats));
    }

    function loadChat(id) {
      currentChatId = id;
      renderChatList();
      chatContainer.innerHTML = ''; // clear previous messages
      const chat = chats.find(c => c.id === id);
      if (chat && chat.messages.length) {
        chat.messages.forEach(msg => addMessage(msg.role, msg.content, false));
        chatContainer.scrollTop = chatContainer.scrollHeight;
      }
    }

    function addMessage(role, content, animate = true) {
      const chat = chats.find(c => c.id === currentChatId);
      if (!chat) return;

      // Always create a new bubble
      const bubble = document.createElement('div');
      bubble.className = `message ${role === 'user' ? 'user-message' : 'ai-message'}`;
      bubble.innerHTML = `
        <div class="avatar">${role === 'user' ? 'You' : 'E'}</div>
        <div class="message-content">${content}</div>
      `;
      chatContainer.appendChild(bubble);

      if (animate && role === 'assistant') {
        const contentEl = bubble.querySelector('.message-content');
        typeWriter(contentEl, content, () => chatContainer.scrollTop = chatContainer.scrollHeight);
      } else {
        chatContainer.scrollTop = chatContainer.scrollHeight;
      }

      chat.messages.push({ role, content });

      // Auto-set title from first user message
      if (role === 'user' && chat.title === 'New Chat' && chat.messages.length === 1) {
        chat.title = content.slice(0, 35) + (content.length > 35 ? '...' : '');
        saveChats();
        renderChatList();
      }

      saveChats();
    }

    function typeWriter(element, text, callback) {
      let i = 0;
      element.innerHTML = '';
      const cursor = document.createElement('span');
      cursor.className = 'blinking-cursor';
      cursor.textContent = '|';
      element.appendChild(cursor);

      function type() {
        if (i < text.length) {
          element.insertBefore(document.createTextNode(text.charAt(i)), cursor);
          i++;
          setTimeout(type, 8 + Math.random() * 6);
        } else {
          cursor.remove();
          element.querySelectorAll('pre code').forEach(Prism.highlightElement);
          if (callback) callback();
        }
      }
      type();
    }

    // Rename chat
    function renameChat(id) {
      const chat = chats.find(c => c.id === id);
      if (!chat) return;
      const newTitle = prompt("New chat name:", chat.title);
      if (newTitle && newTitle.trim()) {
        chat.title = newTitle.trim();
        saveChats();
        renderChatList();
      }
    }

    // Delete chat
    function deleteChat(id) {
      if (!confirm("Delete this chat?")) return;
      chats = chats.filter(c => c.id !== id);
      if (currentChatId === id) {
        currentChatId = chats.length > 0 ? chats[0].id : null;
        if (currentChatId) loadChat(currentChatId);
        else chatContainer.innerHTML = '';
      }
      saveChats();
      renderChatList();
    }

    // Auto-resize textarea
    const textarea = document.getElementById('prompt');
    textarea.addEventListener('input', () => {
      textarea.style.height = 'auto';
      textarea.style.height = textarea.scrollHeight + 'px';
    });

    // Real Groq AI ‚Äì full history
    document.getElementById('generateBtn').addEventListener('click', async () => {
      const prompt = textarea.value.trim();
      if (!prompt) return;

      addMessage('user', prompt);

      textarea.value = '';
      textarea.style.height = 'auto';

      const chat = chats.find(c => c.id === currentChatId);
      if (!chat) return;

      const tempMsg = document.createElement('div');
      tempMsg.className = 'message ai-message';
      tempMsg.innerHTML = `<div class="avatar">E</div><div class="message-content" id="currentReply"></div>`;
      chatContainer.appendChild(tempMsg);

      const replyEl = document.getElementById('currentReply');
      chatContainer.scrollTop = chatContainer.scrollHeight;

      const messagesForApi = chat.messages.map(msg => ({
        role: msg.role,
        content: msg.content
      }));

      messagesForApi.push({ role: 'user', content: prompt });

      const GROQ_API_KEY = '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';

      try {
        const res = await fetch('https://api.groq.com/openai/v1/chat/completions', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${GROQ_API_KEY}`
          },
          body: JSON.stringify({
            model: 'llama-3.3-70b-versatile',
            messages: [
              {
                role: 'system',
                content: `You are Grok as ElXora ‚Äî a very helpful, all-round AI assistant. You can help with almost anything: coding (especially Roblox Luau), explanations, creative writing, advice, homework, ideas, translations, brainstorming, fun conversation, etc.

You NEVER assist with:
- Hacking, cracking, cheating, exploits, account stealing, phishing
- Anything illegal, harmful, malicious, or against terms of service of any platform/app/game (especially Roblox)
- Generating NSFW, explicit, violent, or hateful content
- Bypassing filters or safety rules

Respond naturally, friendly, witty when appropriate, but always stay helpful and safe.`
              },
              ...messagesForApi
            ],
            temperature: 0.7,
            max_tokens: 2200
          })
        });

        if (!res.ok) throw new Error('Groq error: ' + res.status);

        const data = await res.json();
        let reply = data.choices[0].message.content.trim();

        if ((reply.includes('function') || reply.includes('local ') || reply.includes('game:GetService')) && !reply.includes('```lua')) {
          reply = '```lua\n' + reply + '\n```';
        }

        typeWriter(replyEl, reply, () => {
          chatContainer.scrollTop = chatContainer.scrollHeight;
          addMessage('assistant', reply, false);
          tempMsg.remove();
        });

      } catch (e) {
        typeWriter(replyEl, `-- Error: ${e.message}\nTry again later.`);
        chatContainer.scrollTop = chatContainer.scrollHeight;
        tempMsg.remove();
      }
    });

    // Enter to send
    textarea.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        document.getElementById('generateBtn').click();
      }
    });
  </script>
</body>
</html>
