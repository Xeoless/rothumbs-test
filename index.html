<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ElXora - AI Lua Scripter for Roblox</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Orbitron:wght@500;700&display=swap" rel="stylesheet"/>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-okaidia.min.css" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
  <!-- Google Identity Services -->
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <style>
    /* ... all your CSS remains unchanged ... */
  </style>
</head>
<body>

  <!-- Google Login Screen -->
  <div class="access-screen" id="accessScreen">
    <div class="access-card">
      <h1 class="glow">ElXora</h1>
      <p>Login with Google to continue</p>

      <!-- Google Sign-In Button -->
      <div id="g_id_onload"
           data-client_id="1091074303503-gsgnp618bh4vd2n9d0it9acs4ctujhc4.apps.googleusercontent.com"
           data-callback="handleGoogleLogin"
           data-auto_prompt="false">
      </div>
      <div class="g_id_signin" data-type="standard" data-size="large" data-theme="filled_black" data-text="signin_with" data-shape="rectangular" data-logo_alignment="left"></div>

      <p id="errorMsg" class="error"></p>
    </div>
  </div>

  <!-- Sidebar with user profile + chat list -->
  <div class="sidebar" id="sidebar">
    <div class="sidebar-header">ElXora</div>

    <div class="user-profile" id="userProfile" style="display:none;">
      <img id="userAvatar" class="user-avatar" src="" alt="Profile" />
      <div class="user-info">
        <div id="userName" class="user-name"></div>
        <div id="userEmail" class="user-email"></div>
      </div>
    </div>

    <div class="new-chat" id="newChatBtn">+ New Chat</div>
    <div class="chat-list" id="chatList"></div>
  </div>

  <!-- Main chat area -->
  <div class="main" id="mainContent" style="display:none;">
    <div class="chat-header">Chat with ElXora</div>
    <div class="chat-messages" id="chatContainer"></div>

    <div class="input-bar">
      <div class="input-icon" title="Attach file/image">ðŸ“Ž</div>
      <div class="input-icon" title="Voice mode">ðŸŽ¤</div>
      <textarea id="prompt" placeholder="Ask me anything Roblox..." rows="1"></textarea>
      <button id="generateBtn" class="send-btn">Send</button>
    </div>
  </div>

  <script>
    // Google Login Handler â€“ FIXED
    function handleGoogleLogin(response) {
      const jwt = response.credential;
      const payload = JSON.parse(atob(jwt.split('.')[1]));

      console.log("Google User:", payload);

      // Save user info
      localStorage.setItem("google_user", JSON.stringify(payload));

      // âœ… Hide login screen
      document.getElementById('accessScreen').style.display = 'none';

      // Show main app and sidebar
      document.getElementById('mainContent').style.display = 'flex';
      document.getElementById('sidebar').style.display = 'block';

      // Show user profile
      document.getElementById('userProfile').style.display = 'flex';
      document.getElementById('userAvatar').src = payload.picture || 'https://via.placeholder.com/48';
      document.getElementById('userName').textContent = payload.name || 'User';
      document.getElementById('userEmail').textContent = payload.email || 'No email';

      alert("Welcome " + payload.name + "!");
    }

    // Auto-login check on page load
    const savedUser = localStorage.getItem("google_user");
    if (savedUser) {
      const payload = JSON.parse(savedUser);

      // âœ… Hide login screen
      document.getElementById('accessScreen').style.display = 'none';

      document.getElementById('mainContent').style.display = 'flex';
      document.getElementById('sidebar').style.display = 'block';
      document.getElementById('userProfile').style.display = 'flex';
      document.getElementById('userAvatar').src = payload.picture || 'https://via.placeholder.com/48';
      document.getElementById('userName').textContent = payload.name || 'User';
      document.getElementById('userEmail').textContent = payload.email || 'No email';
    }

    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // Chat code remains exactly the same
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    let chats = JSON.parse(localStorage.getItem('elxora_chats')) || [{ id: Date.now(), title: 'New Chat', messages: [] }];
    let currentChatId = chats[0].id;

    const chatListEl = document.getElementById('chatList');
    const chatContainer = document.getElementById('chatContainer');
    const newChatBtn = document.getElementById('newChatBtn');

    function renderChatList() {
      chatListEl.innerHTML = '';
      chats.forEach(chat => {
        const item = document.createElement('div');
        item.className = 'chat-item' + (chat.id === currentChatId ? ' active' : '');
        item.textContent = chat.title || 'New Chat';
        item.onclick = () => loadChat(chat.id);
        chatListEl.appendChild(item);
      });
    }

    function saveChats() {
      localStorage.setItem('elxora_chats', JSON.stringify(chats));
    }

    function loadChat(id) {
      currentChatId = id;
      renderChatList();
      chatContainer.innerHTML = '';
      const chat = chats.find(c => c.id === id);
      if (chat && chat.messages.length) {
        chat.messages.forEach(msg => addMessage(msg.role, msg.content, false));
        chatContainer.scrollTop = chatContainer.scrollHeight;
      }
    }

    function addMessage(role, content, animate = true) {
      const chat = chats.find(c => c.id === currentChatId);
      if (!chat) return;

      const bubble = document.createElement('div');
      bubble.className = `message ${role === 'user' ? 'user-message' : 'ai-message'}`;
      bubble.innerHTML = `
        <div class="avatar">${role === 'user' ? 'You' : 'E'}</div>
        <div class="message-content">${content}</div>
      `;
      chatContainer.appendChild(bubble);

      if (animate && role === 'assistant') {
        const contentEl = bubble.querySelector('.message-content');
        typeWriter(contentEl, content, () => chatContainer.scrollTop = chatContainer.scrollHeight);
      } else {
        chatContainer.scrollTop = chatContainer.scrollHeight;
      }

      chat.messages.push({ role, content });
      saveChats();
    }

    function typeWriter(element, text, callback) {
      let i = 0;
      element.innerHTML = '';
      const cursor = document.createElement('span');
      cursor.className = 'blinking-cursor';
      cursor.textContent = '|';
      element.appendChild(cursor);

      function type() {
        if (i < text.length) {
          element.insertBefore(document.createTextNode(text.charAt(i)), cursor);
          i++;
          setTimeout(type, 8 + Math.random() * 6);
        } else {
          cursor.remove();
          element.querySelectorAll('pre code').forEach(Prism.highlightElement);
          if (callback) callback();
        }
      }
      type();
    }

    newChatBtn.onclick = () => {
      const newId = Date.now();
      chats.push({ id: newId, title: 'New Chat', messages: [] });
      currentChatId = newId;
      saveChats();
      renderChatList();
      chatContainer.innerHTML = '';
    };

    const textarea = document.getElementById('prompt');
    textarea.addEventListener('input', () => {
      textarea.style.height = 'auto';
      textarea.style.height = textarea.scrollHeight + 'px';
    });

    document.getElementById('generateBtn').addEventListener('click', async () => {
      const prompt = textarea.value.trim();
      if (!prompt) return;
      addMessage('user', prompt);
      textarea.value = '';
      textarea.style.height = 'auto';

      const tempMsg = document.createElement('div');
      tempMsg.className = 'message ai-message';
      tempMsg.innerHTML = `<div class="avatar">E</div><div class="message-content" id="currentReply"></div>`;
      chatContainer.appendChild(tempMsg);

      const replyEl = document.getElementById('currentReply');
      chatContainer.scrollTop = chatContainer.scrollHeight;

      const GROQ_API_KEY = 'gsk_...'; // Keep secure in real deployment

      try {
        const res = await fetch('https://api.groq.com/openai/v1/chat/completions', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${GROQ_API_KEY}` },
          body: JSON.stringify({
            model: 'llama-3.3-70b-versatile',
            messages: [
              {role: 'system', content: 'You are Grok as ElXora â€” fast Roblox Luau scripter. Respond quick, helpful, witty. Always wrap any Luau code in ```lua ... ```.'},
              {role: 'user', content: prompt}
            ],
            temperature: 0.7,
            max_tokens: 2200
          })
        });

        if (!res.ok) throw new Error('Groq error');

        const data = await res.json();
        let reply = data.choices[0].message.content.trim();

        if ((reply.includes('function') || reply.includes('local ') || reply.includes('game:GetService')) && !reply.includes('```lua')) {
          reply = '```lua\n' + reply + '\n```';
        }

        typeWriter(replyEl, reply, () => {
          chatContainer.scrollTop = chatContainer.scrollHeight;
          addMessage('assistant', reply, false);
          tempMsg.remove();
        });

      } catch (e) {
        typeWriter(replyEl, `-- Error: ${e.message}`);
        chatContainer.scrollTop = chatContainer.scrollHeight;
      }
    });

    textarea.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        document.getElementById('generateBtn').click();
      }
    });

    renderChatList();
    loadChat(currentChatId);
  </script>
</body>
</html>
